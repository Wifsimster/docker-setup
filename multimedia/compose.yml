name: multimedia

services:
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - UMASK=002
    volumes:
      - ${BAZARR_CONFIG_PATH}:/config
      - ${TV_SHOWS_LOCATION}:/data/tv
      - ${MOVIES_LOCATION}:/data/movies
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"

      # Entrypoint
      - "traefik.http.routers.bazarr.entrypoints=websecure"

      # Router
      - "traefik.http.routers.bazarr.rule=Host(`bazarr.${DOMAIN}`)"

      # Service
      - "traefik.http.services.bazarr.loadBalancer.server.port=6767"

      # Watchtower automatic update
      - "com.centurylinklabs.watchtower.enable=true"

    networks:
      lan:

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - UMASK=002
    volumes:
      - ${LIDARR_CONFIG_PATH}:/config
      - ${MUSIC_LOCATION}:/data/music
      - ${DOWNLOADS_LOCATION}:/data/downloads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8686/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"

      # Entrypoint
      - "traefik.http.routers.lidarr.entrypoints=websecure"

      # Router
      - "traefik.http.routers.lidarr.rule=Host(`lidarr.${DOMAIN}`)"

      # Service
      - "traefik.http.services.lidarr.loadBalancer.server.port=8686"

      # Watchtower automatic update
      - "com.centurylinklabs.watchtower.enable=true"

    networks:
      lan:

  seerr:
    image: ghcr.io/hotio/seerr:latest
    container_name: seerr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - UMASK=002
      - TZ=${TZ}
    volumes:
      - ${SEERR_CONFIG_PATH}:/config
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5055 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"

      # Entrypoint
      - "traefik.http.routers.seerr.entrypoints=websecure"

      # Router
      - "traefik.http.routers.seerr.rule=Host(`seerr.${DOMAIN}`)"

      # Service
      - "traefik.http.services.seerr.loadBalancer.server.port=5055"

      # Watchtower automatic update
      - "com.centurylinklabs.watchtower.enable=true"

    networks:
      lan:

  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    restart: unless-stopped
    network_mode: host  # Container joins host's network stack
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM}
      - UMASK=002
    security_opt:
      - no-new-privileges:true
    devices:
      - /dev/dri:/dev/dri  # For hardware transcoding
    tmpfs:
      - /transcode:size=8g  # RAM-based temp storage for transcoding
    volumes:
      - ${PLEX_CONFIG_PATH}:/config
      - ${TV_SHOWS_LOCATION}:/data/tv:ro
      - ${MOVIES_LOCATION}:/data/movies:ro
      - ${MUSIC_LOCATION}:/data/music:ro
    healthcheck:
      test: ["CMD", "curl", "--connect-timeout", "15", "--silent", "--show-error", "--fail", "http://localhost:32400/identity"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 12G
          cpus: "8.0"
    labels:
      # Watchtower automatic update
      - "com.centurylinklabs.watchtower.enable=true"

    # networks:
    #   lan:

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - UMASK=002
    volumes:
      - ${PROWLARR_CONFIG_PATH}:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"

      # Entrypoint
      - "traefik.http.routers.prowlarr.entrypoints=websecure"

      # Router
      - "traefik.http.routers.prowlarr.rule=Host(`indexer.${DOMAIN}`)"

      # Service
      - "traefik.http.services.prowlarr.loadBalancer.server.port=9696"

      # Watchtower automatic update
      - "com.centurylinklabs.watchtower.enable=true"

    networks:
      lan:

  qbittorrent:
    image: ghcr.io/hotio/qbittorrent:latest
    container_name: qbittorrent
    hostname: qbittorrent.internal
    restart: unless-stopped
    # Note: no-new-privileges not set â€” NET_ADMIN required for VPN tunnel
    deploy:
      resources:
        limits:
          memory: 1G
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - UMASK=${UMASK}
      - TZ=${TZ}
      - WEBUI_PORTS=${WEBUI_PORTS}
      - LIBTORRENT=${LIBTORRENT}
      # VPN Configuration
      - VPN_ENABLED=${VPN_ENABLED}
      - VPN_CONF=${VPN_CONF}
      - VPN_PROVIDER=${VPN_PROVIDER}
      - VPN_LAN_NETWORK=${VPN_LAN_NETWORK}
      - VPN_LAN_LEAK_ENABLED=${VPN_LAN_LEAK_ENABLED:-false}
      - VPN_EXPOSE_PORTS_ON_LAN=${VPN_EXPOSE_PORTS_ON_LAN:-}
      - VPN_AUTO_PORT_FORWARD=${VPN_AUTO_PORT_FORWARD}
      - VPN_AUTO_PORT_FORWARD_TO_PORTS=${VPN_AUTO_PORT_FORWARD_TO_PORTS:-}
      - VPN_FIREWALL_TYPE=${VPN_FIREWALL_TYPE:-auto}
      - VPN_HEALTHCHECK_ENABLED=${VPN_HEALTHCHECK_ENABLED}
      - VPN_NAMESERVERS=${VPN_NAMESERVERS:-}
    volumes:
      - ${CONFIG_LOCATION}:/config
      - ${DOWNLOADS_LOCATION}:/data/downloads
      - ./wireguard:/config/wireguard
    ports:
      - "${BT_PORT}:6881"
      - "${BT_PORT}:6881/udp"
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=1
    devices:
      - /dev/net/tun:/dev/net/tun
    labels:
      - "traefik.enable=true"

      # Entrypoint
      - "traefik.http.routers.qbittorrent.entrypoints=websecure"

      # Router
      - "traefik.http.routers.qbittorrent.rule=Host(`qbittorrent.${DOMAIN}`)"

      # Service
      - "traefik.http.services.qbittorrent.loadBalancer.server.port=8080"

      # Watchtower automatic update
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8080 || exit 1
      interval: 15s
      timeout: 3s
      retries: 3
      start_period: 60s
      start_interval: 5s

    networks:
      lan:

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - UMASK=002
    volumes:
      - ${RADARR_CONFIG_PATH}:/config
      - ${MOVIES_LOCATION}:/data/movies
      - ${DOWNLOADS_LOCATION}:/data/downloads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"

      # Entrypoint
      - "traefik.http.routers.radarr.entrypoints=websecure"

      # Router
      - "traefik.http.routers.radarr.rule=Host(`radarr.${DOMAIN}`)"

      # Service
      - "traefik.http.services.radarr.loadBalancer.server.port=7878"

      # Watchtower automatic update
      - "com.centurylinklabs.watchtower.enable=true"

    networks:
      lan:

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - UMASK=002
    volumes:
      - ${SONARR_CONFIG_PATH}:/config
      - ${TV_SHOWS_LOCATION}:/data/tv
      - ${DOWNLOADS_LOCATION}:/data/downloads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"

      # Entrypoint
      - "traefik.http.routers.sonarr.entrypoints=websecure"

      # Router
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.${DOMAIN}`)"

      # Service
      - "traefik.http.services.sonarr.loadBalancer.server.port=8989"

      # Watchtower automatic update
      - "com.centurylinklabs.watchtower.enable=true"

    networks:
      lan:

  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - UMASK=002
    volumes:
      - ${TAUTULLI_CONFIG_PATH}:/config
      - ${PLEX_CONFIG_PATH}/Library/Application Support/Plex Media Server/Logs:/logs:ro
    healthcheck:
      test: ["CMD", "curl", "-ILfs", "http://localhost:8181/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"

      # Entrypoint
      - "traefik.http.routers.tautulli.entrypoints=websecure"

      # Router
      - "traefik.http.routers.tautulli.rule=Host(`tautulli.${DOMAIN}`)"

      # Service
      - "traefik.http.services.tautulli.loadBalancer.server.port=8181"

      # Watchtower automatic update
      - "com.centurylinklabs.watchtower.enable=true"

    networks:
      lan:

networks:
  lan:
    external: true
